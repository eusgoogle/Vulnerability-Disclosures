# MNDT-2023-0007

## Description
An Out-of-bound(OOB) read vulnerability exists in the affected `Excel.exe`, that could potentially read potions of heap memory.

## Impact
Information Disclosure

## Exploitability
Important - Any authenticated local user can exploit the vulnerability and read portions of heap memory.

## CVE Reference
CVE-2023-33162

## Common Vulnerability Scoring System
Base Score: 5.5 - Vector: CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:N/A:N/E:U/RL:O/RC:C

## Technical Details
Upon enumerating certain [Pivot Table](https://en.wikipedia.org/wiki/Pivot_table) of Microsoft Excel spreadsheet, an OOB read occurs and could potentially read portions of heap memory. A crash occurs as of following:

    (988.27d4): Access violation - code c0000005 (first/second chance not available)
    First chance exceptions are reported before any exception handling.
    This exception may be expected and handled.
    Time Travel Position: B501EE:0
    eax=00000000 ebx=3569ab9c ecx=13d9404d edx=00000000 esi=35760a58 edi=35760a58
    eip=00bb515b esp=038ddf30 ebp=038ddf5c iopl=0         nv up ei pl nz na po nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
    EXCEL!HrMapItems+0x292:
    00bb515b 8b0481          mov     eax,dword ptr [ecx+eax*4] ds:002b:13d9404d=????????
    0:000> kb
    # ChildEBP RetAddr      Args to Child
    00 038ddf5c 00bb3a22     00000000 fffffffe 00000000 EXCEL!HrMapItems+0x292
    01 038de230 00b9f4b5     3356d4bc 1d4964c4 1dc6ec48 EXCEL!FRefreshHpsxview+0x41f
    02 038de268 009c7779     3569ab9c 038de2c8 02d1864c EXCEL!FSxviewsOnSxdbUpdate+0x38
    03 038de290 00b9f45e     1d4964c4 00b9f47d 038de2c8 EXCEL!XLSWORKBOOK::EnumPivotTables+0x27
    04 038de2ac 00bb33df     038de2c8 3569ab9c 33571530 EXCEL!RefreshCacheNonTensor::Testability::IRefreshHelper::HrUpdatePivotViews+0x1d
    05 038de338 00b56969     3569ab9c 00000000 3558e9c4 EXCEL!RefreshCacheNonTensor::MdexecDoRefresh+0x321
    06 038dee70 0114314b     00000000 3558e9c4 00000000 EXCEL!MdexecRefreshCache+0x3ab
    07 038dee98 01a88a54     3569ab9c 3558e9c4 3569ab9c EXCEL!SXVIEWSXSCREFRESH::_HrRefreshSxview+0x59
    08 038deec4 01143090     3569ab9c 3558e9c4 038defac EXCEL!CLNTSXREFRESH::_HrRefreshSxview+0x175
    09 038deee4 01142216     33571530 3356d4bc 3569ab9c EXCEL!SXVIEWSXSCREFRESH::_HrRefreshSxdb+0x6e
    0a 038def10 011431fe     32f8c784 038defac 038defc8 EXCEL!SXVIEWSXSCREFRESH::NATIVESVUNIT::HrTxNeededDoRefresh+0x5d
    0b 038def40 009dc305     1dc6ecec 3365e07c 038defac EXCEL!SXVIEWSXSCREFRESH::_HrTxDoUnit+0xa3
    0c 038def70 009dc220     33571160 00000000 00000000 EXCEL!SXVIEWSXSCREFRESH::HrDo+0xa6
    0d 038defe0 009dba8d     009dac32 76e0cff0 ffffffff EXCEL!CLNTSXREFRESH::HrDo+0x76
    0e 038defe0 009db97c     038df184 038df184 00000000 EXCEL!HrPerformWritebackActions+0xedf
    0f 038df0ec 009db8f8     038df184 32f8c660 038df184 EXCEL!HrHostRefreshAllSx+0x6e
    10 038df138 009db889     02c71540 00000000 00000000 EXCEL!REFRESHDATA::HrRefreshAllNonPP+0x5f
    11 038df138 009db613     33571160 33571374 00000000 EXCEL!REFRESHDATA::HrRefreshAll+0x195
    12 038df288 009f13d4     00000001 00000000 00000001 EXCEL!HrRefreshAllBookArls+0x1fe
    13 038df2d8 00726dad     13df2bb0 13df2bb0 00000000 EXCEL!DoPendingAutoRefresh+0xd6
    14 038df800 007263e9     13df2bb0 030741cc 00000001 EXCEL!FDoIdleHardRejectUi+0xa05
    15 038df880 0071f63b     70152dee 030743c0 00000000 EXCEL!FDoIdle+0x9d
    16 038dfc80 006b6904     00000000 0000000a 004a4000 EXCEL!MainLoop+0x12e7
    17 038dfeb0 006a11c3     006a0000 00000000 13da4512 EXCEL!WinMain+0x6fe
    18 038dfefc 76e100f9     004a4000 76e100e0 038dff68 EXCEL!_imp_load__RmGetList+0x1c7
    19 038dff0c 772d7bbe     004a4000 86f5ee2a 00000000 KERNEL32!BaseThreadInitThunk+0x19
    1a 038dff68 772d7b8e     ffffffff 772f8d18 00000000 ntdll!__RtlUserThreadStart+0x2f
    1b 038dff78 00000000     00000000 00000000 00000000 ntdll!_RtlUserThreadStart+0x1b
    
Where the heap memory address `13d9404d` was acquired and OOB occurred in `mso20win32client!GetPvZeroAlloc`. 

    mso20win32client!GetPvZeroAlloc+0x2d:
    701a734d 8b0d603d6870    mov     ecx,dword ptr [mso20win32client!vpZeroAllocs (70683d60)] ds:002b:70683d60=13d90000
    eax=ffffe000 ebx=00000202 ecx=13d90000 edx=ffffc000 esi=00000202 edi=ffffe000
    eip=701a7353 esp=038dded8 ebp=038ddee8 iopl=0         nv up ei pl zr na pe nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
    mso20win32client!GetPvZeroAlloc+0x33:
    701a7353 8931            mov     dword ptr [ecx],esi  ds:002b:13d90000=00000202
    eax=ffffe000 ebx=00000202 ecx=13d90000 edx=ffffc000 esi=00000202 edi=ffffe000
    eip=701a7355 esp=038dded8 ebp=038ddee8 iopl=0         nv up ei pl zr na pe nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
    mso20win32client!GetPvZeroAlloc+0x35:
    701a7355 c1e605          shl     esi,5                                          // 0x202 * 0x20 = 0x4040
    eax=ffffe000 ebx=00000202 ecx=13d90000 edx=ffffc000 esi=00004040 edi=ffffe000
    eip=701a7358 esp=038dded8 ebp=038ddee8 iopl=0         nv up ei pl nz na po nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
    mso20win32client!GetPvZeroAlloc+0x38:
    701a7358 8d0431          lea     eax,[ecx+esi]                                  // 0x13d94040, oob [1]
    eax=13d94040 ebx=00000202 ecx=13d90000 edx=ffffc000 esi=00004040 edi=ffffe000
    eip=701a735b esp=038dded8 ebp=038ddee8 iopl=0         nv up ei pl nz na po nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200202
    mso20win32client!GetPvZeroAlloc+0x3b:
    701a735b 0345fc          add     eax,dword ptr [ebp-4] ss:002b:038ddee4=0000000d // 0x13d9404d, oob [2]
    eax=13d9404d ebx=00000202 ecx=13d90000 edx=ffffc000 esi=00004040 edi=ffffe000
    eip=701a735e esp=038dded8 ebp=038ddee8 iopl=0         nv up ei pl nz na pe nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200206
    mso20win32client!GetPvZeroAlloc+0x3e:
    701a735e 5f              pop     edi

## Resolution
The issue was fixed as part of July 2023 Microsoft security update.

## Discovery Credits
- Dhanesh Kizhakkinan, Google Cloud + Mandiant, FLARE OTF
- Genwei Jiang, Google Cloud + Mandiant, FLARE OTF

## Disclosure Timeline
- 05-May-2023 - Issue reported to MSFT
- 11-July-2023 - Patched version released by MSFT
 
## References
- [Microsoft Advisory](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-33162)
- [Mitre CVE-2023-33162](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-33162)
